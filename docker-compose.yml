version: "3.9"

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage       # ðŸ”„ Named volume
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334

  ingest:
    build:
      context: .
      dockerfile: ./backend/Dockerfile.ingest
    container_name: ingest
    env_file:
      - .env
    depends_on:
      - qdrant
    environment:
      QDRANT_HOST: qdrant
      QDRANT_COLLECTION: hugging_face_documents
    volumes:
      - ./data:/app/data

  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
      POSTGRES_DB: appdb
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U appuser" ]
      interval: 3s
      timeout: 5s
      retries: 10

  langfuse:
    image: langfuse/langfuse:2
    container_name: langfuse
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DATABASE_URL: postgres://appuser:apppass@postgres:5432/appdb
      NEXTAUTH_SECRET: supersecretdevkey
      SALT: anotherrandomsalt
      NEXTAUTH_URL: http://localhost:3000
      LANGFUSE_INIT_ORG_ID: kontron
      LANGFUSE_INIT_ORG_NAME: Kontron
      LANGFUSE_INIT_PROJECT_ID: rag_traces
      LANGFUSE_INIT_PROJECT_NAME: Rag Traces
      LANGFUSE_INIT_USER_NAME: Admin
      LANGFUSE_INIT_USER_EMAIL: admin@example.com
      LANGFUSE_INIT_USER_PASSWORD: admin123
    ports:
      - "3000:3000"

#  index-manager:
#    build:
#      context: .
#      dockerfile: apps/Dockerfile.index_manager
#    container_name: index-manager
#    env_file:
#      - .env
#    environment:
#      QDRANT_HOST: qdrant
#      QDRANT_PORT: 6333
#      PG_HOST: postgres
#      PG_PORT: 5432
#      PG_USER: appuser
#      PG_PASSWORD: apppass
#      PG_DB: appdb
#      LANGFUSE_HOST: http://langfuse:3000
#    ports:
#      - "8501:8501"
#    volumes:
#      - ./data:/app/data                  # âœ… Keep local folder
#    depends_on:
#      - qdrant
#      - postgres
#      - langfuse

  chatbot:
    build:
      context: .
      dockerfile: apps/Dockerfile.chatbot
    container_name: chatbot
    env_file:
      - .env
    environment:
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      PG_HOST: postgres
      PG_PORT: 5432
      PG_USER: appuser
      PG_PASSWORD: apppass
      PG_DB: appdb
      LANGFUSE_HOST: http://langfuse:3000
      QDRANT_COLLECTION: hugging_face_documents
    depends_on:
      ingest:
        condition: service_completed_successfully
      qdrant:
        condition: service_started
      postgres:
        condition: service_healthy
      langfuse:
        condition: service_started
    ports:
      - "8502:8502"


volumes:
  qdrant_data:
  pg_data:
