version: "3.9"

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334

  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
      POSTGRES_DB: appdb
    ports:
      - "5432:5432"
    volumes:
      - ./pg_data:/var/lib/postgresql/data

  langfuse:
    image: langfuse/langfuse:2
    container_name: langfuse
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgres://appuser:apppass@postgres:5432/appdb
      NEXTAUTH_SECRET: supersecretdevkey
      SALT: anotherrandomsalt
      NEXTAUTH_URL: http://localhost:3000
    ports:
      - "3000:3000"

  index-manager:
    build:
      context: .
      dockerfile: apps/Dockerfile.index_manager
    container_name: index-manager
    env_file:
      - .env
    environment:
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      PG_HOST: postgres
      PG_PORT: 5432
      PG_USER: appuser
      PG_PASSWORD: apppass
      PG_DB: appdb
      LANGFUSE_HOST: http://langfuse:3000
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data          # âœ… Correct volume mount
    depends_on:
      - qdrant
      - postgres
      - langfuse

  chatbot:
    build:
      context: .
      dockerfile: apps/Dockerfile.chatbot
    container_name: chatbot
    env_file:
      - .env
    environment:
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      PG_HOST: postgres
      PG_PORT: 5432
      PG_USER: appuser
      PG_PASSWORD: apppass
      PG_DB: appdb
      LANGFUSE_HOST: http://langfuse:3000
    ports:
      - "8502:8502"
    depends_on:
      - qdrant
      - postgres
      - langfuse
